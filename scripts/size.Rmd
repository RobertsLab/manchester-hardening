---
title: "Oyster size"
author: "Ariana S Huffmyer"
date: "2025"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

This script analyzes oyster size. 

# Set Up    

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
library(tidyverse)
library(stringr)
library(readxl)
library(purrr)
library(lubridate)
library(ggplot2)
library(seacarb)
library(broom)
library(cowplot)
library(lme4)
library(lmerTest)
```

# Read in files 

Read in data 
```{r}
size1<-read_csv("data/size/size_initial.csv")%>%select(!notes)%>%select(!initials)
size2<-read_csv("data/size/size_20250923.csv")%>%select(!notes)%>%select(!initials)%>%
  mutate(length.mm=length.mm*10, 
         width.mm=width.mm*10)

metadata<-read_xlsx("data/metadata/experiment_metadata.xlsx")
```

Join data together. 

```{r}
dim(size1)
dim(size2)

data<-full_join(size1, size2)
dim(data)

data<-left_join(data, metadata)
head(data)
```

# Calculate oyster volume 

Calculate volume using equations as an ellipsoid.

```{r}
calc_oyster_volume <- function(length_mm, width_mm, k = 0.21) {
  k * length_mm * (width_mm^2)
}

data$volume.mm3 <- calc_oyster_volume(data$length.mm, data$width.mm)
```

View data. 
```{r}
hist(data$volume.mm3)
```

# Analyze final size

```{r}
data<-data%>%
  mutate(tag=as.factor(tag))%>%
  mutate(date=as.factor(date))
```

```{r}
plot1<-data%>%
  
  ggplot(aes(x=tag, y=volume.mm3, color=treatment))+
  facet_wrap(~date, nrow=2)+
  geom_boxplot()+
  geom_point(position=position_dodge(0.75))+
  scale_color_manual(values=c("blue", "red"))+
  ylab("Volume (mm3)")+
  xlab("Family")+
  theme_classic(); plot1
```

We are missing photos of tags 76, 77, 78, and 79 (YC24-099). 

Analyze just final size. 

```{r}
plot2<-data%>%
  filter(date=="20250923")%>%
  
  ggplot(aes(x=family, y=volume.mm3, color=treatment))+
  geom_boxplot()+
  geom_point(position=position_dodge(0.75))+
  scale_color_manual(values=c("blue", "red"))+
  ylab("Volume (mm3)")+
  xlab("Family")+
  theme_classic(); plot2

ggsave(plot2, filename="figures/size/family_size.png", width=8, height=4)
```

Run a model. 

```{r}
model<-data%>%
  filter(date=="20250923")%>%
  
  lmer(volume.mm3 ~ family * treatment + (1|tag) + (1|cage), data=.)

anova(model)
```

Family is significant, treatment effects are not significant.  


# Analyze growth rates

This will exclude YC24-099 due to missing initial photos. 

```{r}
plot1<-data%>%
  
  ggplot(aes(x=treatment, y=volume.mm3, color=treatment, shape=date, group=interaction(date, treatment)))+
  facet_wrap(~family, nrow=2)+
  geom_boxplot()+
  geom_point(position=position_dodge(0.75))+
  geom_smooth(method="lm", aes(group=interaction(date, treatment)))+
  scale_color_manual(values=c("blue", "red"))+
  ylab("Volume (mm3)")+
  xlab("Date")+
  theme_classic(); plot1

ggsave(plot1, filename="figures/size/family_growth_rate.png", width=8, height=6)
```

Analyze growth to include date.

Run a model. 

```{r}
model<-data%>%
  filter(!family=="YC24-099")%>%
  
  lmer(volume.mm3 ~ date * family * treatment + (1|tag) + (1|cage), data=.)

anova(model)

library(emmeans)

emm <- emmeans(model, ~ date * family * treatment)
pairs(emm, by = c("date", "family"), adjust = "tukey")

plot(emm, comparisons = TRUE, adjust = "tukey")
```

There are some interactive effects present between date x family x treatment. 

Type III Analysis of Variance Table with Satterthwaite's method
                          Sum Sq    Mean Sq NumDF   DenDF   F value    Pr(>F)    
date                  4.4681e+10 4.4681e+10     1 1576.13 1877.1077 < 2.2e-16 ***
family                1.3807e+09 1.7259e+08     8   15.65    7.2507 0.0004566 ***
treatment             3.5061e+07 3.5061e+07     1    2.02    1.4730 0.3478276    
date:family           5.0243e+09 6.2803e+08     8 1576.14   26.3846 < 2.2e-16 ***
date:treatment        1.8740e+08 1.8740e+08     1 1576.13    7.8728 0.0050801 ** 
family:treatment      3.5514e+08 4.4393e+07     8   15.65    1.8650 0.1389266    
date:family:treatment 1.7635e+09 2.2043e+08     8 1576.14    9.2607 1.535e-12 ***

